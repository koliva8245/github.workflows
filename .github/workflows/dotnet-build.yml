name: Build

on:
  workflow_call:
    inputs:
      dotnet-sdk:
        required: true
        type: string
      main-project:
        required: true
        type: string
      artifact-name-prefix:
        required: true
        type: string
      is-tool:
        required: true
        type: boolean
    secrets:
      es-username:
        required: true
      es-password:
        required: true
      es-credential-id:
        required: true
      es-totp-secret:
        required: true
        
env:
  PUBLISH_ANY_PATH: ./bin/publish/any
  NUPKG_PATH: ./bin/nupkg/any
  PACKAGE_VERSION_FILE: ./version.txt
  
jobs:
  build-test:
    strategy:
      matrix:
        os: [windows-latest, macos-latest, ubuntu-latest]
        configuration: [Debug, Release]
        include:
          - os: windows-latest
            configuration: Debug
            cache: true

    runs-on: ${{ matrix.os }}

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Cache checkout
      if: ${{ matrix.cache }}
      uses: actions/cache/save@v3
      with:
        path: ${{ github.workspace }}
        key: checkout-${{ github.run_id }}-${{ github.run_attempt }}
          
    - name: Use dotnet sdk
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ inputs.dotnet-sdk }}

    - name: Build
      run: dotnet build -c ${{ matrix.configuration }}

    - name: Test
      run: dotnet test -c ${{ matrix.configuration }} --no-build
           
  package:
    needs: build-test
    runs-on: windows-latest
    steps:
    - name: Cache checkout
      id: cache-checkout
      uses: actions/cache/restore@v3
      with:
        path: ${{ github.workspace }}
        key: checkout-${{ github.run_id }}-${{ github.run_attempt }}
        
    - name: Checkout
      if: steps.cache-checkout.outputs.cache-hit != 'true'
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Use dotnet sdk
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ inputs.dotnet-sdk }}

    - name: Set non-main branch version build number
      shell: pwsh
      if: github.ref != 'refs/heads/main'
      run: | 
        $xml = [Xml] (Get-Content ${{ inputs.main-project }})
        $version = $xml.Project.PropertyGroup.Version
        echo "Current version - $version"
        $first_part_version,$build_version = $version.Split("-")
        $new_version = $first_part_version + "-build.${{ github.run_number }}"        
        $content = Get-Content ${{ inputs.main-project }}
        $content | % { $_.Replace("<Version>$version</Version>", "<Version>$new_version</Version>") } | Set-Content ${{ inputs.main-project }}

    - name: Get package version
      shell: pwsh
      run: |
        $xml = [Xml] (Get-Content ${{ inputs.main-project }})
        $version = $xml.Project.PropertyGroup.Version
        echo "New version - $version"
        echo "VERSION=$version" | Out-File -FilePath ${{ env.PACKAGE_VERSION_FILE }} -Encoding utf8 -Append
        
    - name: Publish
      if: ${{ inputs.is-tool }}
      run: dotnet publish ${{ inputs.main-project }} -o $env:PUBLISH_ANY_PATH

    - name: Nuget Pack
      run: dotnet pack ${{ inputs.main-project }} --no-build -o $env:NUPKG_PATH  

    - name: Cache publish files
      if: ${{ inputs.is-tool }}
      uses: actions/cache/save@v3
      with:
        path: |
          ${{ env.PUBLISH_ANY_PATH }}
        key: publish-${{ github.run_id }}-${{ github.run_attempt }}
        enableCrossOsArchive: true

    - name: Cache nuget packages
      uses: actions/cache/save@v3
      with:
        path: |
          ${{ env.NUPKG_PATH }}
          ${{ env.PACKAGE_VERSION_FILE }}
        key: nuget-${{ github.run_id }}-${{ github.run_attempt }}
        enableCrossOsArchive: true
        
  sign-nuget:
    needs: package
    runs-on: windows-latest
    if: github.ref == 'refs/heads/main'
    steps:
    - name: Restore nuget file
      id: nuget-cache
      uses: actions/cache/restore@v3
      with:
        path: |
          ${{ env.NUPKG_PATH }}
          ${{ env.PACKAGE_VERSION_FILE }}
        key: nuget-${{ github.run_id }}-${{ github.run_attempt }}
        enableCrossOsArchive: true
        fail-on-cache-miss: true

    - name: Get version
      shell: bash
      run: |
        . version.txt
        echo $VERSION
        echo "version=$VERSION" | tr -d '\r\n' >> "$GITHUB_ENV"
        
    - name: Download and Unzip CodeSignTool
      run: |
        Invoke-WebRequest -OutFile CodeSignTool.zip "https://www.ssl.com/download/codesigntool-for-windows/"
        Expand-Archive -Force CodeSignTool.zip
        Remove-Item CodeSignTool.zip
        Add-Content -Path .\CodeSignTool\conf\code_sign_tool.properties -Value "`nTSA_LEGACY_URL=http://ts.ssl.com/legacy"
        
    - name: Sign artifacts
      run: |
        $path = $env:NUPKG_PATH -replace "/", "\"
        $relativePath = $path +  '\' + '${{ inputs.artifact-name-prefix }}' + '.' + '${{ env.version }}' + '.nupkg'
        $npath = Resolve-Path -Path (Join-Path -Path '${{ github.workspace }}' -ChildPath $relativePath)
        echo "$npath"

        $spath = $npath -replace '\.nupkg$', '.snupkg'
        $tempSPath = $spath -replace '\.snupkg$', '.symbols.nupkg'
        Rename-Item -Path $spath -NewName $tempSPath
        echo "$tempSPath"

        cd CodeSignTool
        .\CodeSignTool.bat sign -username=${{ secrets.es-username }} -password=${{ secrets.es-password }} -credential_id=${{ secrets.es-credential-id }} -totp_secret=${{ secrets.es-totp-secret }} -input_file_path="$npath" -override
        .\CodeSignTool.bat sign -username=${{ secrets.es-username }} -password=${{ secrets.es-password }} -credential_id=${{ secrets.es-credential-id }} -totp_secret=${{ secrets.es-totp-secret }} -input_file_path="$tempSPath" -override
        $outputN = nuget verify -Signatures $npath
        if ($outputN -like '*failed*') { exit 1 }
        $outputS = nuget verify -Signatures $tempSPath
        if ($outputS -like '*failed*') { exit 1 }

        cd ..
        Rename-Item -Path $tempSPath -NewName $spath
        echo "$spath"
        
    - name: Cache signed nuget packages
      uses: actions/cache/save@v3
      with:
        path: |
          ${{ env.NUPKG_PATH }}
          ${{ env.PACKAGE_VERSION_FILE }}
        key: nuget-signed-${{ github.run_id }}-${{ github.run_attempt }}
        enableCrossOsArchive: true
        
  upload-artifacts:
    needs: sign-nuget
    runs-on: ubuntu-latest
    if: ${{ always() }}
    steps:
    - name: Restore publish files
      if: ${{ inputs.is-tool }}
      id: publish-cache
      uses: actions/cache/restore@v3
      with:
        path: |
          ${{ env.PUBLISH_ANY_PATH }}
        key: publish-${{ github.run_id }}-${{ github.run_attempt }}
        enableCrossOsArchive: true
        fail-on-cache-miss: true
        
    - name: Restore signed nuget file
      id: nuget-signed-cache
      uses: actions/cache/restore@v3
      if: github.ref == 'refs/heads/main'
      with:
        path: |
          ${{ env.NUPKG_PATH }}
          ${{ env.PACKAGE_VERSION_FILE }}
        key: nuget-signed-${{ github.run_id }}-${{ github.run_attempt }}
        enableCrossOsArchive: true
        fail-on-cache-miss: true

    - name: Restore nuget file
      id: nuget-cache
      uses: actions/cache/restore@v3
      if: github.ref != 'refs/heads/main'
      with:
        path: |
          ${{ env.NUPKG_PATH }}
          ${{ env.PACKAGE_VERSION_FILE }}
        key: nuget-${{ github.run_id }}-${{ github.run_attempt }}
        enableCrossOsArchive: true
        fail-on-cache-miss: true
      
    - name: Get version
      run: |
        . version.txt
        echo $VERSION
        echo "version=$VERSION" | tr -d '\r\n' >> "$GITHUB_ENV"
        
    - name: Archive Release Files - Zip
      if: ${{ inputs.is-tool }}
      run: 7z a -tzip '${{ runner.temp }}/${{ inputs.artifact-name-prefix }}.${{ env.version }}.zip' '${{ env.PUBLISH_ANY_PATH }}'

    - name: Archive Release Files - Tar
      if: ${{ inputs.is-tool }}
      shell: pwsh
      run: |
        $lastPart = (Split-Path ${{ env.PUBLISH_ANY_PATH }} -Leaf)
        $parentPath = (Split-Path ${{ env.PUBLISH_ANY_PATH }} -Parent)
        tar -czvf '${{ runner.temp }}/${{ inputs.artifact-name-prefix }}.${{ env.version }}.tar.gz' -C $parentPath $lastPart
        
    - name: Upload Artifacts - Release Files - Zip
      if: ${{ inputs.is-tool }} == 'true'
      uses: actions/upload-artifact@v3
      with:
        name: ${{ inputs.artifact-name-prefix }}
        path: "${{ runner.temp }}/*.zip"
        if-no-files-found: error
        
    - name: Upload Artifacts - Release Files - Tar
      if: ${{ inputs.is-tool }} == 'true'
      uses: actions/upload-artifact@v3
      with:
        name: ${{ inputs.artifact-name-prefix }}
        path: "${{ runner.temp }}/*.tar.gz"
        if-no-files-found: error

    - name: Upload Artifacts - Nuget
      uses: actions/upload-artifact@v3
      with:
        name: ${{ inputs.artifact-name-prefix }}-Nuget
        path: ${{ env.NUPKG_PATH }}/
        if-no-files-found: error
